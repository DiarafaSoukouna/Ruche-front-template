import Button from "../../../components/Button";
import Input from "../../../components/Input";
import { addLocalite } from "../../../functions/localites/post";
import { updateLocalite } from "../../../functions/localites/put";
import { typeLocalite } from "../../../functions/localites/types";
import Select, { SingleValue } from "react-select";
import { typeNiveauLocalite } from "../../../functions/niveauLocalites/types";
import { localiteByParent } from "../../../functions/localites/gets";
import { useEffect, useState } from "react";
import { Controller, useForm } from "react-hook-form";

interface Props {
    all: () => void;
    onClose: () => void;
    niveau: number;
    parent: number;
    niveauLocalites: typeNiveauLocalite[];
    localites: typeLocalite[];
    editRow: typeLocalite | null;
}

const FormLocalite: React.FC<Props> = ({ editRow, all, onClose, parent, niveauLocalites, niveau, localites }) => {
    const defaultValue = typeof editRow?.parent_loca === 'object'?
        editRow.parent_loca as typeLocalite : 
        null
    const [selectedOption, setSelectedOption] = useState<OptionType | null>(
    defaultValue ? {
        value: String(defaultValue.id_loca),
        label: defaultValue.intitule_loca
    } : null
);
    const parentIndex = parent - 1;
    const parentInfo = niveauLocalites[parentIndex]
    const [localite, setLocalite] = useState<typeLocalite[]>([])
    const [localiteByNiv, setLocaliteByNiv] = useState<typeLocalite[]>([])
    const { control, handleSubmit, register, formState: { errors } } = useForm<typeLocalite>({ mode: "onTouched" })
    const onSubmit = async (data: typeLocalite) => {
        let payload: typeLocalite;
        console.log("data", data)
        if (parentInfo) {
            payload = {
                intitule_loca: data.intitule_loca as string,
                code_national_loca: data.code_national_loca as string,
                code_loca: data.code_loca as string,
                parent_loca: data.parent_loca as string,
                niveau_loca: niveau,
                id_loca: editRow?.id_loca,
            };
        } else {
            payload = {
                intitule_loca: data.intitule_loca as string,
                code_national_loca: data.code_national_loca as string,
                code_loca: data.code_loca as string,
                niveau_loca: niveau,
                id_loca: editRow?.id_loca,
            };
        }
        try {
            let res;
            if (editRow) {
                res = await updateLocalite(payload);
                console.log("Updated:", res);
            } else {
                res = await addLocalite(payload);
                console.log("Created:", res);
            }
            onClose()
            all();
        } catch (error) {
            console.log("error", error);
        }
    };
    const LocaliteByNiveau = async (id: number | null) => {
        const res = localites.filter((loc) => loc.niveau_loca === id);
        setLocaliteByNiv(res);
        return res;
    };
    const LocaliteByParent = async (id: number) => {
        try {
            const res = await localiteByParent(id)
            // setLocalite()
        } catch (error) {
            console.log(error)
        }
    }
    useEffect(() => {
        if (parentInfo) {
            LocaliteByNiveau(parentInfo.id_nlc ? parentInfo.id_nlc : null)
        }
    }, [])
    console.log('parentInfo', editRow)
    const defaultValue = typeof editRow?.parent_loca === 'object'?
        editRow.parent_loca as typeLocalite : 
        null
    type OptionType = {
        value: string | null;
        label: string;
    };
     const localiteOptions = localites.map(item => ({
        value: String(item.id_loca),
        label: item.intitule_loca
    }));
    return (
        <div className="space-y-4">
            <form onSubmit={handleSubmit(onSubmit)} name="niveauLocaliteForm">
                <div className="grid grid-cols-12 gap-4">
                    <div className="col-span-6">
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                            Libelle
                        </label>
                        <input
                            placeholder="Entrer le libelle"
                            {...register("intitule_loca", { required: "Ce champ est obligatoire" })}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            defaultValue={editRow?.intitule_loca || ""}
                        />
                    </div>
                    <div className="col-span-6">
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                            Code national
                        </label>
                        <input
                            placeholder="Entrer le code natonal"
                            {...register("code_national_loca", { required: "Ce champ est obligatoire" })}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            defaultValue={editRow?.code_national_loca || ""}
                        />
                    </div>
                    <div className="col-span-6">
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                            Code
                        </label>
                        <input
                            placeholder="Entrer le code"
                            {...register("code_loca", { required: "Ce champ est obligatoire" })}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            defaultValue={editRow?.code_loca || ""}
                        />
                    </div>
                    {parentInfo &&
                        <div className="col-span-6">
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                {parentInfo.libelle_nlc}
                            </label>
                            <Controller
                                name="parent_loca"
                                control={control}
                                defaultValue={defaultValue ? {
                                    value: String(defaultValue?.id_loca),
                                    label: defaultValue.intitule_loca
                                } : null}
                                render={({ field }) => (
                                    <Select<OptionType>
                                        {...field}
                                        options={localiteOptions}
                                        isClearable
                                        placeholder="Sélectionner"
                                        className="react-select-container"
                                        classNamePrefix="react-select"
                                        value={localiteOptions.find(opt => String(opt.value) === field.value) || null}
                                        onChange={(option: SingleValue<OptionType>) => field.onChange(option ? option.value : null)}
                                    />
                                )}
                            />
                            {errors.parent_loca && (
                                <p className="text-red-500 text-sm mt-1">
                                    {errors.parent_loca.message}
                                </p>
                            )}
                            {/* <Select
                                name="parent_loca"
                                defaultValue={defaultValue ? {
                                    value: String(defaultValue?.id_loca),
                                    label: defaultValue.intitule_loca
                                } : null}
                                options={localiteByNiv.map(item => ({
                                    value: String(item.id_loca),
                                    label: item.intitule_loca
                                }))}
                                isClearable
                                placeholder="Sélectionner un parent..."
                            /> */}
                        </div>
                    }

                </div>
                <div className="flex space-x-3 pt-4 justify-end">
                    <Button variant="outline" onClick={onClose} className="">
                        Annuler
                    </Button>
                    <Button className="" type="submit">
                        {editRow ? "Mettre à jour" : "Valider"}
                    </Button>
                </div>
            </form>
        </div>
    );
};

export default FormLocalite;
